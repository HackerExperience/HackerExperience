services:
  clickhouse:
    image: clickhouse/clickhouse-server:latest
    container_name: clickhouse
    restart: unless-stopped
    ports:
      - "8123:8123"
      - "9000:9000"
      - "9009:9009"
    ulimits:
      nofile:
        soft: 262144
        hard: 262144
    volumes:
      - clickhouse-data:/var/lib/clickhouse
      - clickhouse-logs:/var/log/clickhouse-server
      - clickhouse-config:/etc/clickhouse-server
    networks:
      - observability

  mongo:
    image: mongo:7
    container_name: hyperdx-mongo
    restart: unless-stopped
    environment:
      MONGO_INITDB_DATABASE: hyperdx
    volumes:
      - mongo-data:/data/db
    networks:
      - observability

  hyperdx:
    image: docker.hyperdx.io/hyperdx/hyperdx:latest
    container_name: hyperdx
    restart: unless-stopped
    environment:
      MONGO_URI: mongodb://mongo:27017/hyperdx
      HYPERDX_LOG_LEVEL: info
      HYPERDX_OPAMP_PORT: 4320
    ports:
      - "8050:8080"
      - "4320:4320"  # OpAMP for collector management
    depends_on:
      - mongo
    networks:
      - observability

  otel-collector:
    image: hyperdx/hyperdx-otel-collector:latest
    container_name: hyperdx-otel-collector
    restart: unless-stopped
    environment:
      CLICKHOUSE_ENDPOINT: http://clickhouse:8123
      CLICKHOUSE_USER: default
      CLICKHOUSE_PASSWORD: ""

      OPAMP_SERVER_URL: http://hyperdx:4320

      HYPERDX_LOG_LEVEL: info
    ports:
      - "4317:4317" # OTLP gRPC
      - "4318:4318"  # OTLP HTTP
      - "13133:13133"  # health check
      - "8888:8888"  # metrics
    depends_on:
      - clickhouse
      - hyperdx
    networks:
      - observability

volumes:
  clickhouse-data:
  clickhouse-logs:
  clickhouse-config:
  mongo-data:

networks:
  observability:
